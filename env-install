#!/usr/bin/env bash

: "${OS:=$(uname -s | awk '{print tolower($0)}')}"

script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

check_env_var() {
    local var_name="$1"
    local var_value="${!var_name}"

    if [ -z "$var_value" ]; then
        echo "env var $var_name needs to be present"
        exit 1
    fi
}

check_env_var "DEV_ENV"
check_env_var "OS"

export DEV_ENV OS

grep=""
dry_run="0"

while [[ $# -gt 0 ]]; do
    echo "ARG: \"$1\""
    if [[ "$1" == "--dry" ]]; then
        dry_run="1"
    else
        grep="$1"
    fi
    shift
done

log() {
    if [[ $dry_run == "1" ]]; then
        echo "[DRY_RUN]: $1"
    else
        echo "$1"
    fi
}

log "RUN: os: $OS -- env: $DEV_ENV -- grep: $grep"

update_files() {
    log "copying over files from: $1"
    pushd "$1" &> /dev/null || exit
    (
        configs=$(find . -mindepth 1 -maxdepth 1 -type d)
        for c in $configs; do
            dir=${2%/}/${c#./}
            log "    removing: rm -rf $dir"

            if [[ $dry_run == "0" ]]; then
                rm -rf "$dir"
            fi

            log "    copying env: cp $c $2"
            if [[ $dry_run == "0" ]]; then
                cp -r "./$c" "$2"
            fi
        done

    )
    popd &> /dev/null || exit
}

copy() {
    log "removing: $2"
    if [[ $dry_run == "0" ]]; then
        rm "$2"
    fi
    log "copying: $1 to $2"
    if [[ $dry_run == "0" ]]; then
        cp "$1" "$2"
    fi
}

update_files "$DEV_ENV"/env/.config "${XDG_CONFIG_HOME:-${2:-$HOME/.config}}"
update_files "$DEV_ENV"/env/.local "$HOME"/.local
update_files "$DEV_ENV"/env/personal "$HOME"/.config

copy "$DEV_ENV"/tmux-sessionizer/tmux-sessionizer "$HOME"/.local/scripts/tmux-sessionizer
copy "$DEV_ENV"/env/.zsh_profile "$HOME"/.zsh_profile
copy "$DEV_ENV"/env/.zshrc "$HOME"/.zshrc
[[ $OS == "linux" ]] && cp "$DEV_ENV"/env/.xprofile "$HOME"/.xprofile
copy "$DEV_ENV"/env/.tmux-sessionizer "$HOME"/.tmux-sessionizer
copy "$DEV_ENV"/env-install "$HOME"/.local/scripts/env-install

installs_dir=$(find "$script_dir"/installs "$script_dir"/private/installs -mindepth 1 -maxdepth 1 -type f -perm -111)

for s in $installs_dir; do
    if basename "$s" | grep -vq "$grep"; then
        log "grep \"$grep\" filtered out $s"
        continue
    fi

    log "running script: $s"

    if [[ $dry_run == "0" ]]; then
        $s
    fi
done

mkdir -p "$HOME"/.local/bin

